<!DOCTYPE html>
<meta charset=utf-8>
<title>Tenori-on</title>

<h1>Tenori-on</h1>
<script src="src/buffer-loader.js"></script>
<script>
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();
var bufferLoader = new BufferLoader(
  context,
  ['samples/drums/kick2.wav',
   'samples/drums/snare1.wav',
   'samples/instrument.wav',
   'samples/drums/hat1.wav',
   'samples/bass1.wav',
   'samples/fx/goutte.wav'
  ],
  done
)

bufferLoader.load();

var sheet = [
 "xxxx  xxxx      x       xx  xx  ",
 "        xx              xxxx    ",
 "    x x         xxxxxxxxxxxxxxxx",
 "x x x x x x x x x x x x x x x x ",
 "                            xxxx",
 "xxxxxxxxxxxxxxxxxxxxxxxx        "
]
var duration = 1 / 12; // sec

function done(buffers, now) {
    now = now || context.currentTime + .1;
    var fade = duration / 4;
    for (var j=0; j < sheet.length; j++) {
        var track = sheet[j],
            s = sound(buffers[j]),
            playing = false;
        for (var i=0; i < track.length; i++) {
            var t = now + i * duration
            if (track[i] == 'x') {
                if (!playing) {
                    s.source.start(t)
                    // fade in
                    s.gain.gain.linearRampToValueAtTime(0, t)
                    s.gain.gain.linearRampToValueAtTime(1, t + fade)
                    playing = true
                }
            } else {
                if (playing) {
                    s.source.stop(now + i * duration)
                    // fade out
                    s.gain.gain.linearRampToValueAtTime(1, t - fade)
                    s.gain.gain.linearRampToValueAtTime(0, t)
                    playing = false
                    s = sound(buffers[j])
                }
            }
        }
    }
    setTimeout(
        function(){ done(buffers, now + i * duration) },
        (now - context.currentTime) + (i - 1) * duration * 1000
    )
}

function sound(buffer) {
    var source = context.createBufferSource()
    var gain = context.createGain()
    source.buffer = buffer
    source.connect(gain)
    gain.connect(context.destination)
    return {source: source, gain: gain}
}
</script>
