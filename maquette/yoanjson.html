<!DOCTYPE html>
<meta charset=utf-8>
<title>Tenori-off</title>

<h1>Tenori-off</h1>
<button disabled>Play</button>
<script>
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();

var timeout;
var currentTime;

var btn =document.querySelector("button");

btn.onclick=toggle;

function toggle(){
    if (context.state === "running") {
        context.suspend().then(function() {
            btn.innerHTML = "Play"
            clearTimeout(timeout)
        })
    } else {
        context.resume().then(function() {
            btn.innerHTML = "Pause"
            play(currentTime)
        })
    }
}

var data = {
	"tracks":[
		{
			"sample":"samples/drums/kick3.wav",
			"notes":[
				{"pos":0,"len":2},
				{"pos":6,"len":2},
				{"pos":12,"len":2},
				{"pos":20,"len":2},
				{"pos":24,"len":2}
			]
		},
		{
			"sample":"samples/drums/snare2.wav",
			"notes":[
				{"pos":8,"len":2},
				{"pos":24,"len":2},
				{"pos":30,"len":2}
			]
		},
		{
			"sample":"samples/drums/shaker.wav",
			"notes":[
				{"pos":2,"len":1},
				{"pos":4,"len":1},
				{"pos":6,"len":1},
				{"pos":8,"len":1},
				{"pos":12,"len":1},
				{"pos":16,"len":1},
				{"pos":20,"len":1},
				{"pos":24,"len":1},
				{"pos":28,"len":1}
			]
		},
		{
			"sample":"samples/drums/hat1.wav",
			"notes":[
				{"pos":2,"len":1},
				{"pos":6,"len":1},
				{"pos":10,"len":1},
				{"pos":14,"len":1},
				{"pos":18,"len":1},
				{"pos":24,"len":1},
				{"pos":28,"len":1}
			]
		}
	]
}

// memento
var bpm=120; // ==tempo
var beatLen = 60.0 / bpm; // ==seconds per beat
var barLen = 240/bpm; //sec // ==beatLen*4
var unit = barLen/32; // ==beatLen/8
var fade = 1/128; // arbitraire


function loadSound(url) {
    return new Promise(function(resolve, reject){
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function() {
            // Asynchronously decode the audio file data in request.response
            context.decodeAudioData(
                request.response,
                function(buffer) {
                    if (buffer) {
                        resolve(buffer)
                    } else {
                        reject('error decoding file data: ' + url)
                    }
                },
                function(error) {
                    reject('decodeAudioData error: ' + error)
                }
            )
        }
        request.send()
    })
}

// init buffers
(function(){
    var nbSonsCharges=0;
    data.tracks.forEach(function(track){
        loadSound(track.sample).then(function(buffer){
            console.log(track.sample, "is loaded")
            track.buffer = buffer
        }, function(error) {
            console.error(track.sample, error)
        }).then(function() {
            nbSonsCharges++;
            if(nbSonsCharges==data.tracks.length)
                init();
        })
    })
})()

function init(){
    btn.disabled=false;
    context.suspend().then(function() {
        currentTime = context.currentTime
    })
}

function play(){
    var now = currentTime

	data.tracks.forEach(function(track){
		track.notes.forEach(function(note){
			// on recrée la source à chaque fois car on ne peux pas appeler start() plusieurs fois sur la même source
			s = sound(track.buffer);
			s.source.start(now + unit*note.pos);
			end = now + unit*note.pos + unit*note.len;
			s.source.stop(end);
			s.gain.gain.linearRampToValueAtTime(1, end - fade)
			s.gain.gain.linearRampToValueAtTime(0, end)
		});
	});


    if (context.state === "running") {
        var avance = now - (context.currentTime);

        // fait en sorte que l'avance reste autour de 100ms
        currentTime = now + barLen
        timeout = setTimeout(play, (barLen - (.1 - avance)) * 1000)
    }
}

// todo
function stop(){
	//context.suspend()
}

function sound(buffer) {
    var source = context.createBufferSource()
    var gain = context.createGain()
    source.buffer = buffer
    source.connect(gain)
    gain.connect(context.destination)
    return {source: source, gain: gain}
}
</script>
