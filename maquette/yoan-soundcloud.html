<!DOCTYPE html>
<meta charset=utf-8>
<title>View</title>

<h1>Poor man's soundcloud.</h1>

<script>
"use strict";

// Lib
function loadSound(url) {
    return new Promise(function(resolve, reject){
        var request = new XMLHttpRequest();
        request.open('GET', url, true);
        request.responseType = 'arraybuffer';
        request.onload = function() {
            // Asynchronously decode the audio file data in request.response
            context.decodeAudioData(
                request.response,
                function(buffer) {
                    if (buffer) {
                        resolve(buffer)
                    } else {
                        reject('error decoding file data: ' + url)
                    }
                },
                function(error) {
                    reject('decodeAudioData error: ' + error)
                }
            )
        }
        request.send()
    })
}

function analyseSound(buffer) {
    return new Promise(function(resolve, reject) {
        var source = context.createBufferSource(),
            analyser = context.createAnalyser(),
            volumes = [],
            analysing = true
        source.buffer = buffer
        source.connect(analyser)
        // be quiet
        //source.connect(context.destination)
        source.addEventListener("ended", function(e) {
            source.stop()
            analysing = false
        }, false)
        analyser.fftSize = 32

        var dataArray = new Uint8Array(analyser.frequencyBinCount);
        var fn =  function() {
            var value = context.currentTime
            analyser.getByteFrequencyData(dataArray)
            volumes.push(dataArray.reduce(function(a,b) { return a + b}) / dataArray.length)
            if (analysing) {
                requestAnimationFrame(fn)
            } else {
                resolve(volumes)
            }
        }

        requestAnimationFrame(fn)
        source.start()
        // FIXME: it never rejects...
    })
}

// App
window.audioContext = window.AudioContext || window.webkitAudioContext
var context = new AudioContext()

var samples = [
    {"url": "samples/instrument.wav"},
    {"url": "samples/pianonote.wav"},
    {"url": "samples/bass1.wav"},
    {"url": "samples/drums/shaker.wav"},
]
samples.forEach(function(sample) {
    loadSound(sample.url).then(function(buffer){
        sample.buffer = buffer
        sample.duration = buffer.duration
        analyseSound(sample.buffer).then(function(volumes) {
            sample.volumes = volumes
            sample.maxVolume = Math.max.apply(Math, volumes)
            var title = document.createElement("h2")
            title.append(document.createTextNode(
                sample.url + " (" + Math.round(sample.duration * 10) / 10 +"s)"))
            document.body.appendChild(title)
            var audio = document.createElement("audio")
            audio.setAttribute("controls", "controls")
            audio.setAttribute("src", sample.url)
            document.body.appendChild(audio)
            document.body.appendChild(show(sample))
        })
    }, function(error) {
        console.error(error)
    })
})

function show(sample) {
    var canvas = document.createElement("canvas"),
        ctx = canvas.getContext('2d'),
        width = document.body.clientWidth,
        height = 100,
        barWidth = (width / sample.volumes.length)

    canvas.width = width
    canvas.height = height

    sample.volumes.forEach(function(volume, i) {
        // when silent, show a 2px bar
        volume = volume | ((2 * sample.maxVolume) / height)
        ctx.fillStyle = "rgb("+ (255 * (volume / sample.maxVolume) |0) +", 0, 0)"
        ctx.fillRect(
            i * barWidth,
            ((sample.maxVolume - volume) / (2 * sample.maxVolume)) * height,
            barWidth - 1,
            (volume / sample.maxVolume) * height)
    })

    return canvas
}

</script>
